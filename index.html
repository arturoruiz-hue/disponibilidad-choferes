<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Disponibilidad de Choferes</title>
  <meta name="theme-color" content="#0c122c" />
  <style>
    :root{--bg:#0c122c;--card:#12183b;--muted:#2a3264;--accent:#7aa2ff;--ok:#2ecc71;--text:#eef2ff;--sub:#b8c3ff}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1023,#0f1642);color:var(--text);-webkit-tap-highlight-color:transparent}
    header{position:sticky;top:0;z-index:10;background:#0c122c;padding:14px 16px;border-bottom:1px solid #1b2252}
    header h1{margin:0;font-size:18px}
    header .sub{font-size:12px;color:var(--sub);margin-top:4px}
    .wrap{max-width:560px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1b2252;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .hd{padding:14px 16px;border-bottom:1px solid #1b2252}
    .bd{padding:14px 16px}
    label{font-size:12px;color:var(--sub);display:block;margin:10px 0 6px}
    input[type=text],select{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3264;background:#0f1540;color:var(--text)}
    .btn{width:100%;appearance:none;border:none;border-radius:12px;padding:14px;background:var(--accent);color:#08122a;font-weight:800;font-size:16px;margin-top:14px}
    .btn:active{transform:scale(0.995)}
    .ok{display:none;margin-top:10px;font-size:13px;color:#bbf7d0}

    /* Calendario compacto táctil */
    .cal{user-select:none;margin-top:8px}
    .cal .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cal .bar h3{margin:0;font-size:14px}
    .navbtn{border:none;background:#23306b;color:var(--text);border-radius:10px;padding:8px 10px}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-size:10px;color:var(--sub);text-align:center}
    .day{padding:12px 0;border-radius:10px;text-align:center;border:1px solid #27306a;background:#0e1437}
    .day.other{opacity:.35}
    .day.sel{outline:2px solid var(--accent);background:#1a235f}
    .day.today{border-color:var(--accent)}
    .helper{font-size:12px;color:var(--sub);margin-top:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#1a235f;border:1px solid #27306a;border-radius:999px;padding:6px 10px;font-size:12px}

    .note{font-size:12px;color:var(--sub);margin-top:12px}
  </style>
</head>
<body>
  <header>
    <h1>Disponibilidad</h1>
    <div class="sub">Captura semanal • Optimizado para móvil</div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="hd"><strong>Registro</strong></div>
      <div class="bd">
        <label for="driverId">ID de chofer</label>
        <input id="driverId" type="text" inputmode="latin" autocomplete="off" placeholder="Ej. CH-001" />

        <label for="driverName">Nombre del chofer</label>
        <input id="driverName" type="text" list="dlDrivers" placeholder="Nombre completo" autocomplete="off" />
        <datalist id="dlDrivers"></datalist>

        <label for="partner">Nombre del socio</label>
        <select id="partner"></select>

        <label>Selecciona las fechas disponibles</label>
        <div class="cal" id="cal"></div>
        <div class="helper">Toca para alternar días. Mantén pulsado y arrastra para seleccionar varios (en móviles compatibles).</div>
        <div class="chips" id="chips"></div>

        <button id="saveBtn" class="btn">Guardar disponibilidad</button>
        <div id="okMsg" class="ok">✓ Guardado correctamente</div>
        <div class="note">Esta versión no permite descargar ni editar listas. Si necesitas ver reportes o exportar, usa la versión de escritorio.</div>
      </div>
    </section>
  </main>

<script>
// ======= Configuración fija (sin edición en UI) =======
const SOCIOS = [
  "ALVIPACK SAS DE CV (AZCA)",
  "ALEJANDRA VANESSA LEMUS PADILLA",
  "SOCIO A",
  "SOCIO B"
];
const CHOFERES_SUGERIDOS = [
  "KARLA BRITO HERRERA",
  "DANIEL FRADARTURO LAGAR RAMÍREZ",
  "BENJAMIN SALINAS VALTIERRA",
  "ALEJANDRO CRUZ ANGELES",
  "JORGE SANCHEZ COLLAZO"
];
// Si después quieres registrar en Google Sheets, pega tu endpoint Web App aquí:
const ENDPOINT = ""; // p.ej. https://script.google.com/macros/s/AKfycbx.../exec

// ======= Utilidades =======
const LS_KEY = 'dispchoferes.mobile.v1';
const fmtISO = d=> new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
const today = new Date();

function saveLocal(records){
  const s = localStorage.getItem(LS_KEY);
  const db = s? JSON.parse(s): [];
  db.push(...records);
  localStorage.setItem(LS_KEY, JSON.stringify(db));
}

async function sendToEndpoint(records){
  if(!ENDPOINT) return;
  for(const r of records){
    try{ await fetch(ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(r)}); }catch(e){ /* silencioso */ }
  }
}

// ======= Calendario táctil simple (multi-selección) =======
let calState = { ym: new Date(today.getFullYear(), today.getMonth(), 1), selected: new Set() };
let touchStartDay = null;

function buildCalendar(){
  const host = document.getElementById('cal'); host.innerHTML = '';
  const bar = document.createElement('div'); bar.className = 'bar';
  const prev = document.createElement('button'); prev.className='navbtn'; prev.textContent='◀';
  const next = document.createElement('button'); next.className='navbtn'; next.textContent='▶';
  const h3 = document.createElement('h3'); h3.textContent = calState.ym.toLocaleDateString('es-MX',{month:'long',year:'numeric'});
  prev.onclick = ()=>{calState.ym = new Date(calState.ym.getFullYear(), calState.ym.getMonth()-1, 1); buildCalendar(); renderChips();};
  next.onclick = ()=>{calState.ym = new Date(calState.ym.getFullYear(), calState.ym.getMonth()+1, 1); buildCalendar(); renderChips();};
  bar.append(prev,h3,next); host.appendChild(bar);

  const grid = document.createElement('div'); grid.className='grid';
  ['L','M','M','J','V','S','D'].forEach(d=>{const s=document.createElement('div'); s.className='dow'; s.textContent=d; grid.appendChild(s);});

  const first = new Date(calState.ym.getFullYear(), calState.ym.getMonth(), 1);
  const start = new Date(first); start.setDate(start.getDate() - ((start.getDay()+6)%7));

  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const btn = document.createElement('div'); btn.className='day'; btn.textContent = d.getDate();
    if(d.getMonth() !== calState.ym.getMonth()) btn.classList.add('other');
    if(fmtISO(d) === fmtISO(new Date())) btn.classList.add('today');
    if(calState.selected.has(fmtISO(d))) btn.classList.add('sel');

    const iso = fmtISO(d);
    btn.addEventListener('click', ()=>{ toggleDay(iso); });

    // Soporte básico de arrastre táctil (press+drag)
    btn.addEventListener('touchstart', ()=>{ touchStartDay = iso; toggleDay(iso,true); }, {passive:true});
    btn.addEventListener('touchmove', (ev)=>{
      const t = document.elementFromPoint(ev.touches[0].clientX, ev.touches[0].clientY);
      if(!t) return; const cell = t.closest('.day'); if(!cell) return;
      const cells = [...grid.querySelectorAll('.day')];
      const idx = cells.indexOf(cell);
      // idx incluye las 7 celdas de encabezados DOW al inicio
      const d2 = new Date(start); d2.setDate(start.getDate()+idx-7);
      const iso2 = fmtISO(d2);
      if(iso2 && iso2!==touchStartDay){ calState.selected.add(iso2); cell.classList.add('sel'); renderChips(); }
    }, {passive:true});

    grid.appendChild(btn);
  }
  host.appendChild(grid);
}

function toggleDay(iso, silent){
  if(calState.selected.has(iso)) calState.selected.delete(iso); else calState.selected.add(iso);
  if(!silent){ buildCalendar(); renderChips(); }
}

function renderChips(){
  const box = document.getElementById('chips'); box.innerHTML='';
  [...calState.selected].sort().forEach(iso=>{
    const chip = document.createElement('span'); chip.className='chip';
    chip.textContent = new Date(iso).toLocaleDateString('es-MX');
    box.appendChild(chip);
  })
}

// ======= Guardado =======
async function onSave(){
  const id = document.getElementById('driverId').value.trim();
  const name = document.getElementById('driverName').value.trim();
  const socio = document.getElementById('partner').value.trim();
  const dates = [...calState.selected].sort();
  if(!id || !name || !socio){ toast('Completa ID, nombre y socio'); return; }
  if(dates.length===0){ toast('Selecciona al menos una fecha'); return; }

  const ts = new Date().toISOString();
  const records = dates.map(fecha=> ({fecha, id_chofer:id, nombre_chofer:name, socio, ts_captura:ts}));

  saveLocal(records);
  await sendToEndpoint(records);

  calState.selected.clear(); buildCalendar(); renderChips();
  document.getElementById('okMsg').style.display='block';
  setTimeout(()=>{document.getElementById('okMsg').style.display='none'}, 1800);
  // Limpia campos para siguiente chofer
  document.getElementById('driverId').value='';
  document.getElementById('driverName').value='';
}

function toast(msg){
  alert(msg); // minimalista para móvil
}

// ======= Init =======
function init(){
  const sel = document.getElementById('partner');
  SOCIOS.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  const dl = document.getElementById('dlDrivers');
  CHOFERES_SUGERIDOS.forEach(n=>{ const o=document.createElement('option'); o.value=n; dl.appendChild(o); });
  buildCalendar(); renderChips();
  document.getElementById('saveBtn').addEventListener('click', onSave);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
